#!/bin/sh -x
# Script to create a mirror of alibuild repository in an S3 bucket.

. /secrets/aws_bot_secrets
export AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY

bucket=${BUCKET:-alibuild-repo}
prefix=/build/reports/repo
repo=TARS/slc7_x86-64

rclone_sync () {
  # Simple wrapper for rclone, specifying common default options.
  rclone sync --config /secrets/alibuild_rclone_config --transfers=10 --progress --delete-before "$@"
}

# Create a separate filesystem tree, with symlinks only. However, as S3 doesn't
# support real symlinks, make them regular files containing the path they point
# to instead.
symlink_tree=/tmp/repo-symlinks
find $prefix/$repo -type l | while read -r sym; do
  lpath=$symlink_tree/${sym#$prefix/$repo/}
  mkdir -p "$(dirname "$lpath")"
  readlink "$sym" > "$lpath"
done
rclone_sync "local:$symlink_tree/" "rpms3:$bucket/$repo/"

# Sync tarballs from the repo to S3.
rclone_sync "local:$prefix/$repo/store/" "rpms3:$bucket/$repo/store/"
